![æµè§ˆå™¨å†…æ ¸ï¼ˆæ¸²æŸ“è¿›ç¨‹ï¼‰.png](http://ww1.sinaimg.cn/large/92babc53gy1giulcnjkurj21pv0ilq6s.jpg)

### why EventLoop
å„ç§æµè§ˆå™¨äº‹ä»¶åŒæ—¶è§¦å‘æ—¶ï¼Œè‚¯å®šæœ‰ä¸€ä¸ªå…ˆæ¥åŽåˆ°çš„æŽ’é˜Ÿé—®é¢˜ã€‚å†³å®šè¿™äº›äº‹ä»¶å¦‚ä½•æŽ’é˜Ÿè§¦å‘çš„æœºåˆ¶ï¼Œå°±æ˜¯äº‹ä»¶å¾ªçŽ¯ã€‚


### è¿›ç¨‹çº¿ç¨‹
è¿›ç¨‹ï¼šèµ„æºåˆ†é…çš„æœ€å°å•ä½
çº¿ç¨‹ï¼šç¨‹åºæ‰§è¡Œçš„æœ€å°å•ä½
### ä»»åŠ¡é˜Ÿåˆ—
æ‰€æœ‰ä»»åŠ¡å¯ä»¥åˆ†æˆä¸¤ç§ï¼Œä¸€ç§æ˜¯åŒæ­¥ä»»åŠ¡ï¼ˆsynchronousï¼‰ï¼Œå¦ä¸€ç§æ˜¯å¼‚æ­¥ä»»åŠ¡ï¼ˆasynchronousï¼‰ï¼Œ
**åŒæ­¥ä»»åŠ¡**
åœ¨ä¸»çº¿ç¨‹ä¸ŠæŽ’é˜Ÿæ‰§è¡Œçš„ä»»åŠ¡ï¼Œåªæœ‰å‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ‰èƒ½æ‰§è¡ŒåŽä¸€ä¸ªä»»åŠ¡ï¼›
**å¼‚æ­¥ä»»åŠ¡**
ä¸è¿›å…¥ä¸»çº¿ç¨‹ã€è€Œè¿›å…¥"ä»»åŠ¡é˜Ÿåˆ—"ï¼ˆtask queueï¼‰çš„ä»»åŠ¡ï¼Œåªæœ‰"ä»»åŠ¡é˜Ÿåˆ—"é€šçŸ¥ä¸»çº¿ç¨‹ï¼ŒæŸä¸ªå¼‚æ­¥ä»»åŠ¡å¯ä»¥æ‰§è¡Œäº†ï¼Œè¯¥ä»»åŠ¡æ‰ä¼šè¿›å…¥ä¸»çº¿ç¨‹æ‰§è¡Œã€‚

```
ï¼ˆ1ï¼‰æ‰€æœ‰åŒæ­¥ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ªæ‰§è¡Œæ ˆï¼ˆexecution context stackï¼‰ã€‚
ï¼ˆ2ï¼‰ä¸»çº¿ç¨‹ä¹‹å¤–ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ª"ä»»åŠ¡é˜Ÿåˆ—"ï¼ˆtask queueï¼‰ã€‚åªè¦å¼‚æ­¥ä»»åŠ¡æœ‰äº†è¿è¡Œç»“æžœï¼Œå°±åœ¨"ä»»åŠ¡é˜Ÿåˆ—"ä¹‹ä¸­æ”¾ç½®ä¸€ä¸ªäº‹ä»¶ã€‚
ï¼ˆ3ï¼‰ä¸€æ—¦"æ‰§è¡Œæ ˆ"ä¸­çš„æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç³»ç»Ÿå°±ä¼šè¯»å–"ä»»åŠ¡é˜Ÿåˆ—"ï¼Œçœ‹çœ‹é‡Œé¢æœ‰å“ªäº›äº‹ä»¶ã€‚é‚£äº›å¯¹åº”çš„å¼‚æ­¥ä»»åŠ¡ï¼ŒäºŽæ˜¯ç»“æŸç­‰å¾…çŠ¶æ€ï¼Œè¿›å…¥æ‰§è¡Œæ ˆï¼Œå¼€å§‹æ‰§è¡Œã€‚
ï¼ˆ4ï¼‰ä¸»çº¿ç¨‹ä¸æ–­é‡å¤ä¸Šé¢çš„ç¬¬ä¸‰æ­¥ã€‚
```
### å®šæ—¶å™¨
setTimeout(fn,0)æŒ‡å®šæŸä¸ªä»»åŠ¡åœ¨ä¸»çº¿ç¨‹æœ€æ—©å¯å¾—çš„ç©ºé—²æ—¶é—´æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå°½å¯èƒ½æ—©å¾—æ‰§è¡Œã€‚å®ƒåœ¨"ä»»åŠ¡é˜Ÿåˆ—"çš„å°¾éƒ¨æ·»åŠ ä¸€ä¸ªäº‹ä»¶ï¼Œå› æ­¤è¦ç­‰åˆ°åŒæ­¥ä»»åŠ¡å’Œ"ä»»åŠ¡é˜Ÿåˆ—"çŽ°æœ‰çš„äº‹ä»¶éƒ½å¤„ç†å®Œï¼Œæ‰ä¼šå¾—åˆ°æ‰§è¡Œã€‚HTML5æ ‡å‡†è§„å®šäº†setTimeout()çš„ç¬¬äºŒä¸ªå‚æ•°çš„æœ€å°å€¼ï¼ˆæœ€çŸ­é—´éš”ï¼‰ï¼Œä¸å¾—ä½ŽäºŽ4æ¯«ç§’ï¼Œå¦‚æžœä½ŽäºŽè¿™ä¸ªå€¼ï¼Œå°±ä¼šè‡ªåŠ¨å¢žåŠ ã€‚

### Node.js çš„ EventLoop
Nodejsè¿è¡Œæœºåˆ¶
```
ï¼ˆ1ï¼‰V8å¼•æ“Žè§£æžJavaScriptè„šæœ¬ã€‚
ï¼ˆ2ï¼‰è§£æžåŽçš„ä»£ç ï¼Œè°ƒç”¨Node APIã€‚
ï¼ˆ3ï¼‰libuvåº“è´Ÿè´£Node APIçš„æ‰§è¡Œã€‚å®ƒå°†ä¸åŒçš„ä»»åŠ¡åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ï¼Œå½¢æˆä¸€ä¸ªEvent Loopï¼ˆäº‹ä»¶å¾ªçŽ¯ï¼‰ï¼Œä»¥å¼‚æ­¥çš„æ–¹å¼å°†ä»»åŠ¡çš„æ‰§è¡Œç»“æžœè¿”å›žç»™V8å¼•æ“Žã€‚
ï¼ˆ4ï¼‰V8å¼•æ“Žå†å°†ç»“æžœè¿”å›žç»™ç”¨æˆ·ã€‚
```
process.nextTick æ–¹æ³•å¯ä»¥åœ¨å½“å‰"æ‰§è¡Œæ ˆ"çš„å°¾éƒ¨----ä¸‹ä¸€æ¬¡Event Loopï¼ˆä¸»çº¿ç¨‹è¯»å–"ä»»åŠ¡é˜Ÿåˆ—"ï¼‰ä¹‹å‰----è§¦å‘å›žè°ƒå‡½æ•°ã€‚
setImmediate æ–¹æ³•åˆ™æ˜¯åœ¨å½“å‰"ä»»åŠ¡é˜Ÿåˆ—"çš„å°¾éƒ¨æ·»åŠ äº‹ä»¶ã€‚
process.nextTickå’ŒsetImmediateçš„ä¸€ä¸ªé‡è¦åŒºåˆ«ï¼šå¤šä¸ªprocess.nextTickè¯­å¥æ€»æ˜¯åœ¨å½“å‰"æ‰§è¡Œæ ˆ"ä¸€æ¬¡æ‰§è¡Œå®Œï¼Œå¤šä¸ªsetImmediateå¯èƒ½åˆ™éœ€è¦å¤šæ¬¡loopæ‰èƒ½æ‰§è¡Œå®Œã€‚

### å®ä»»åŠ¡
JavaScriptå¤–éƒ¨çš„é˜Ÿåˆ—ï¼Œå¤–éƒ¨é˜Ÿåˆ—ä¸»è¦æ˜¯æµè§ˆå™¨åè°ƒçš„å„ç±»äº‹ä»¶çš„é˜Ÿåˆ—ã€‚
JS ä¸­ï¼Œå¤§éƒ¨åˆ†ä»»åŠ¡éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œçš„ï¼Œå¸¸è§ä»»åŠ¡
- setTimeout
- setInterval 
- requestAnimationFrame 
- I/O
- setImmediate
- æ¸²æŸ“äº‹ä»¶
- ç”¨æˆ·äº¤äº’äº‹ä»¶(é¼ æ ‡ã€é”®ç›˜)
- jsè„šæœ¬æ‰§è¡Œ
- History API æ“ä½œ
- ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™å®Œæˆäº‹ä»¶ç­‰ç­‰ã€‚
å…¶ä¸­ setImmediate åªå­˜åœ¨äºŽnodeä¸­ï¼ŒrequestAnimationFrame åªå­˜åœ¨äºŽ æµè§ˆå™¨ä¸­

JSå¼•æ“Žéœ€è¦å¯¹ä¹‹æ‰§è¡Œçš„é¡ºåºåšä¸€å®šçš„å®‰æŽ’ï¼ŒV8 å…¶å®žé‡‡ç”¨çš„æ˜¯ä¸€ç§é˜Ÿåˆ—çš„æ–¹å¼æ¥å­˜å‚¨è¿™äº›ä»»åŠ¡ï¼Œ å³å…ˆè¿›æ¥çš„å…ˆæ‰§è¡Œã€‚
å°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸€ä¸€å–å‡ºï¼Œç„¶åŽæ‰§è¡Œã€‚ä½†æ˜¯å…¶ä¸­åŒ…å«äº†ä¸¤ç§ä»»åŠ¡é˜Ÿåˆ—ï¼Œé™¤äº†ä¸Šè¿°æåˆ°çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œ è¿˜æœ‰ä¸€ä¸ª**å»¶è¿Ÿé˜Ÿåˆ—**ï¼Œå®ƒä¸“é—¨å¤„ç†è¯¸å¦‚setTimeout/setIntervalè¿™æ ·çš„å®šæ—¶å™¨å›žè°ƒä»»åŠ¡ã€‚

æ™®é€šä»»åŠ¡é˜Ÿåˆ—å’Œå»¶è¿Ÿé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œéƒ½å±žäºŽ**å®ä»»åŠ¡**ã€‚


### å¾®ä»»åŠ¡
JavaScriptè¯­è¨€å†…éƒ¨çš„äº‹ä»¶é˜Ÿåˆ—
å¾®ä»»åŠ¡åŒ…æ‹¬
- Promise
- MutationObserver
- Process.nextTick

å…¶ä¸­process.nextTickåªå­˜åœ¨äºŽNodeä¸­ï¼ŒMutationObserveråªå­˜åœ¨äºŽæµè§ˆå™¨ä¸­ã€‚

å¼•å…¥å¾®ä»»åŠ¡çš„åˆè¡·æ˜¯ä¸ºäº†è§£å†³å¼‚æ­¥å›žè°ƒçš„é—®é¢˜
åœ¨æ¯ä¸€ä¸ªå®ä»»åŠ¡ä¸­å®šä¹‰ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå½“è¯¥å®ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œä¼šæ£€æŸ¥å…¶ä¸­çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¦‚æžœä¸ºç©ºåˆ™ç›´æŽ¥æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡ï¼Œå¦‚æžœä¸ä¸ºç©ºï¼Œåˆ™ä¾æ¬¡æ‰§è¡Œå¾®ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæˆæ‰åŽ»æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡ã€‚
å¸¸è§çš„å¾®ä»»åŠ¡æœ‰ MutationObserverã€Promise.then(æˆ–.reject) ä»¥åŠä»¥ Promise ä¸ºåŸºç¡€å¼€å‘çš„å…¶ä»–æŠ€æœ¯(æ¯”å¦‚fetch API), è¿˜åŒ…æ‹¬ V8 çš„åžƒåœ¾å›žæ”¶è¿‡ç¨‹


äº‹ä»¶çš„æ‰§è¡Œé¡ºåºï¼Œæ˜¯å…ˆæ‰§è¡Œå®ä»»åŠ¡ï¼Œç„¶åŽæ‰§è¡Œå¾®ä»»åŠ¡ã€‚ä»»åŠ¡å¯ä»¥æœ‰åŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡ï¼ŒåŒæ­¥çš„è¿›å…¥ä¸»çº¿ç¨‹ï¼Œå¼‚æ­¥çš„è¿›å…¥ Event Table å¹¶æ³¨å†Œå‡½æ•°ï¼Œå¼‚æ­¥äº‹ä»¶æ‰§è¡Œå®ŒåŽï¼Œä¼šå°†å›žè°ƒå‡½æ•°æ”¾å…¥ Event Queue ä¸­ï¼ŒåŒæ­¥ä»»åŠ¡æ‰§è¡Œå®ŒæˆåŽï¼Œä¼šä»Ž Event Queue ä¸­è¯»å–äº‹ä»¶æ”¾å…¥ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå›žè°ƒå‡½æ•°è¿˜å¯èƒ½åŒ…å«ä¸åŒçš„ä»»åŠ¡ï¼Œå› æ­¤ä¼šå¾ªçŽ¯æ‰§è¡Œä¸Šè¿°æ“ä½œã€‚

**Tips**
ä»¥ä¸Šæ˜¯åœ¨æµè§ˆå™¨ä¸­çš„è¿è¡Œç»“æžœï¼Œåœ¨nodeä¸­çš„è¿è¡Œç»“æžœä¸ä¸€æ ·


### nodejs å’Œ æµè§ˆå™¨å…³äºŽeventLoopçš„ä¸»è¦åŒºåˆ«
ä¸¤è€…æœ€ä¸»è¦çš„åŒºåˆ«åœ¨äºŽæµè§ˆå™¨ä¸­çš„å¾®ä»»åŠ¡æ˜¯åœ¨æ¯ä¸ªç›¸åº”çš„å®ä»»åŠ¡ä¸­æ‰§è¡Œçš„ï¼Œè€Œnodejsä¸­çš„å¾®ä»»åŠ¡æ˜¯åœ¨ä¸åŒé˜¶æ®µä¹‹é—´æ‰§è¡Œçš„ã€‚


### process.nextTick
process.nextTick æ˜¯ä¸€ä¸ªç‹¬ç«‹äºŽ eventLoop çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚
åœ¨æ¯ä¸€ä¸ª eventLoop é˜¶æ®µå®ŒæˆåŽä¼šåŽ»æ£€æŸ¥è¿™ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æžœé‡Œé¢æœ‰ä»»åŠ¡ï¼Œä¼šè®©è¿™éƒ¨åˆ†ä»»åŠ¡ä¼˜å…ˆäºŽå¾®ä»»åŠ¡æ‰§è¡Œã€‚


### await å’Œ promiseæ‰§è¡Œé¡ºåº
async è¿”å›žä¸€ä¸ªpromiseï¼Œè¿”å›žçš„promiseä¼šæ”¾åˆ°å›žè°ƒé˜Ÿåˆ—ä¸­ç­‰å¾…


### Tips
thenä¸­çš„å¾®ä»»åŠ¡å’Œreturn new Promiseä¼˜å…ˆçº§ä¸ä¸€æ · ðŸ‘ˆ
```js
async function async1() {
  console.log('async1 start');
  async2().then(()=>{
    console.log('async1 end');
  });
}

async function async2() {
  console.log('async2');
  return new Promise(((resolve, reject) => resolve()))
}


async1()
new Promise(function(resolve) {
  console.log('promisea');
  resolve();
}).then(function() {
  return new Promise((resolve, reject) => resolve())
}).then(function() {
  console.log('promisec')
})
```
